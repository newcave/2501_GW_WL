import streamlit as st
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
from sklearn.ensemble import RandomForestRegressor
from sklearn.model_selection import train_test_split
from sklearn.metrics import mean_squared_error
import numpy as np

# ğŸ“‚ íŒŒì¼ ì—…ë¡œë“œ ë° ë°ì´í„° ë¡œë”©
@st.cache_data
def load_data(file):
    data = pd.read_excel(file, header=2)  # ì„¸ ë²ˆì§¸ í–‰ì„ ì»¬ëŸ¼ëª…ìœ¼ë¡œ ì‚¬ìš©
    data.columns = data.columns.str.strip()  # ê³µë°± ì œê±°
    return data

# ğŸ“„ ê¸°ë³¸ íŒŒì¼ ë¡œë”© í•¨ìˆ˜
@st.cache_data
def load_default_data():
    data = pd.read_excel("GW_001.xlsx", header=2)  # ì„¸ ë²ˆì§¸ í–‰ì„ ì»¬ëŸ¼ëª…ìœ¼ë¡œ ì‚¬ìš©
    data.columns = data.columns.str.strip()  # ê³µë°± ì œê±°
    return data

# âš™ï¸ ì‚¬ì´ë“œë°” ì„¤ì •
st.sidebar.title("ğŸ›°ï¸ ì§€í•˜ìˆ˜ìœ„ ì˜ˆì¸¡ ì„¤ì •")

# ğŸ“ ì§€ì  ì„ íƒ ì²´í¬ë°•ìŠ¤
use_default = st.sidebar.checkbox("âœ… ê¸°ë³¸ ë°ì´í„°(GW_001.xlsx) ì‚¬ìš©")
uploaded_file = st.sidebar.file_uploader("ğŸ“¤ ì§€ì  ë°ì´í„° ì—…ë¡œë“œ (Excel íŒŒì¼)", type=["xlsx"])

# ğŸ“… ë¦¬ë“œ íƒ€ì„ ì„¤ì •
lead_time = st.sidebar.slider("â³ ë¦¬ë“œ íƒ€ì„ (ì˜ˆì¸¡ ê¸°ê°„, ì¼)", min_value=1, max_value=30, value=7)

# ğŸ”„ ë£©ë°± ì„¤ì •
look_back = st.sidebar.slider("ğŸ” ë£©ë°± ê¸°ê°„ (ê³¼ê±° ë°ì´í„° ì‚¬ìš© ê¸°ê°„, ì¼)", min_value=1, max_value=365, value=30)

# ğŸ”§ í•˜ì´í¼íŒŒë¼ë¯¸í„° ì„¤ì •
n_estimators = st.sidebar.slider("ğŸ› ï¸ # of Estimators (í•˜ì´í¼íŒŒë¼ë¯¸í„°)", min_value=10, max_value=500, step=10, value=100)

# ğŸ“Š ë°ì´í„° ë¡œë”© ë° ì¶œë ¥
if uploaded_file or use_default:
    if uploaded_file:
        data = load_data(uploaded_file)
    else:
        data = load_default_data()
    
    with st.expander("ğŸ” Raw ë°ì´í„° ë³´ê¸°", expanded=False):
        st.write(data)
        st.write(f"ğŸ“‹ **ë°ì´í„° ì»¬ëŸ¼ëª…:** {list(data.columns)}")
    
    # ğŸ“Œ ë…ë¦½ë³€ìˆ˜ ì„ íƒ (ê¸°ë³¸ê°’: ìˆ˜ì˜¨, ì „ë„ë„, ê³„ì¸¡ìˆ˜ìœ„)
    st.subheader("ğŸ“ˆ ë…ë¦½ë³€ìˆ˜ ì„ íƒ")
    independent_vars = st.multiselect(
        "âœ… ì‚¬ìš©í•  ë…ë¦½ë³€ìˆ˜ ì„ íƒ:",
        options=list(data.columns),
        default=[col for col in ["ìˆ˜ì˜¨", "ì „ë„ë„", "ê³„ì¸¡ìˆ˜ìœ„"] if col in data.columns]
    )
    
    # ğŸ¯ ì˜ˆì¸¡ë³€ìˆ˜ ì„ íƒ (ê¸°ë³¸ê°’: ê³„ì¸¡ìˆ˜ìœ„)
    st.subheader("ğŸ¯ ì˜ˆì¸¡ë³€ìˆ˜ ì„ íƒ")
    target_var = st.selectbox(
        "âœ… ì˜ˆì¸¡í•  ë³€ìˆ˜ ì„ íƒ:",
        options=list(data.columns),
        index=list(data.columns).index("ê³„ì¸¡ìˆ˜ìœ„") if "ê³„ì¸¡ìˆ˜ìœ„" in data.columns else 0
    )
    
    # ğŸ”’ ë³€ìˆ˜ ì„¤ì • ì™„ë£Œ ë²„íŠ¼ ì¶”ê°€
    if st.button("ğŸš€ ë³€ìˆ˜ ì„¤ì • ì™„ë£Œ"):
        with st.expander("ğŸ“Œ ì„ íƒí•œ ë³€ìˆ˜ ë³´ê¸°", expanded=False):
            st.write(f"âœ… **ì„ íƒí•œ ë…ë¦½ë³€ìˆ˜:** {independent_vars}")
            st.write(f"ğŸ¯ **ì˜ˆì¸¡ ë³€ìˆ˜:** {target_var}")
            st.write(f"â³ **ë¦¬ë“œ íƒ€ì„:** {lead_time}ì¼, ğŸ” **ë£©ë°± ê¸°ê°„:** {look_back}ì¼, ğŸ› ï¸ **Estimator ìˆ˜:** {n_estimators}")
        
        # ğŸ“Š EDA ì‹œê°í™”
        st.subheader("ğŸ” ê¸°ë³¸ EDA")
        fig, axes = plt.subplots(1, 3, figsize=(18, 5))
        sns.histplot(data[independent_vars[0]], kde=True, bins=30, ax=axes[0])
        axes[0].set_title(f'{independent_vars[0]} Distribution')
        
        sns.histplot(data[independent_vars[1]], kde=True, bins=30, ax=axes[1])
        axes[1].set_title(f'{independent_vars[1]} Distribution')
        
        sns.histplot(data[independent_vars[2]], kde=True, bins=30, ax=axes[2])
        axes[2].set_title(f'{independent_vars[2]} Distribution')
        
        st.pyplot(fig)
        
        fig_corr, ax_corr = plt.subplots(figsize=(8, 6))
        sns.heatmap(data[independent_vars + [target_var]].corr(), annot=True, cmap='coolwarm', ax=ax_corr)
        ax_corr.set_title('Feature Correlation Heatmap')
        st.pyplot(fig_corr)
    
    # ğŸ¤– ëª¨ë¸ í•™ìŠµ ë° ì˜ˆì¸¡
    if st.button("ğŸ“Š ëª¨ë¸ ì‹¤í–‰"):
        missing_cols = [col for col in independent_vars if col not in data.columns]
        if missing_cols:
            st.error(f"âŒ ì„ íƒí•œ ë…ë¦½ë³€ìˆ˜ {missing_cols}ê°€ ë°ì´í„°ì— ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")
        else:
            X = data[independent_vars].apply(pd.to_numeric, errors='coerce').dropna()
            y = pd.to_numeric(data[target_var], errors='coerce').loc[X.index].dropna()
            X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.1, random_state=42)
            model = RandomForestRegressor(n_estimators=n_estimators, random_state=42)
            model.fit(X_train, y_train)
            y_pred = model.predict(X_test)
            mse = mean_squared_error(y_test, y_pred)
            rmse = np.sqrt(mse)
            st.subheader("ğŸ“‰ ëª¨ë¸ ì˜ˆì¸¡ ê²°ê³¼")
            st.write(f"ğŸ“Š **RMSE (Root Mean Squared Error):** {rmse:.4f}")
            st.line_chart(pd.DataFrame({"âœ… ì‹¤ì œê°’": y_test.values, "ğŸ“ˆ ì˜ˆì¸¡ê°’": y_pred}, index=y_test.index))
else:
    st.info("ğŸ’¡ **K-water AI LAB x Groundwater Research Team Collaboration.**")
    col1, col2 = st.columns(2)
    with col1:
        st.image("fig1.png")
    with col2:
        st.video("media.mp4", caption="ğŸ“ ìœ„ì¹˜ë„ ë° ì—¼ë¶„ ë¶„í¬ë„")
